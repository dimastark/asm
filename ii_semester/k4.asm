.model tiny
.code
org 100h

b_port = 61h
cmdreg = 43h
latch2 = 42h 

start:
  xor bx, bx
  mov es, bx
  mov bx, es:[9h*4]
  mov cx, es:[9h*4+2]
  mov word ptr old_09h, bx
  mov word ptr old_09h + 2, cx
  mov es:[9h*4], offset handler
  mov es:[9h*4+2], ds

  xor si, si
  mov al, 0b6h
  out cmdreg, al

  @ended:
  mov byte ptr cur, 6
  @next:
  call term

  mov bx, [melody]
  cmp bx, 0
  je @next

  mov al, [bx][si] 
  cmp al, 0
  je delay_loop
  cmp al, 0ffh
  je @ended
  cbw

  lea bx, frequency
  shl ax, 1 
  mov di, ax
  mov dx, [bx][di]
 
  call init 
  mov al, dl 
  out latch2, al
  mov al, dh
  out latch2, al

  delay_loop:
  mov ah, 0
  int 1ah

  mov bx, [beat]
  cmp bx, 0
  je @next

  mov cl, [bx][si]
  mov ch, 0
  mov bx, dx
  add bx, cx
  sound: 
  int 1ah
  cmp dx, bx
  jne sound
  inc si
  jmp @next
  @end: 
  call term

  mov bx, word ptr old_09h
  mov cx, word ptr old_09h + 2
  mov es:[9h*4], bx
  mov es:[9h*4+2], cx
  mov ax, 4c00h 
  int 21h
  ret

init proc
  in al, b_port
  or al, 00000011b
  out b_port, al
  ret
endp init

term proc
  in al, b_port
  and al, 0fch
  out b_port, al
  ret
endp term

old_09h dw ?, ?

handler proc
  pushf
  call dword ptr old_09h
  in al, 60h
  cmp [cur], al
  je return
  cmp al, 1
  je @end
  cmp al, 2
  je first
  cmp al, 3
  je second
  cmp al, 4
  je third
  cmp al, 5
  je fourth
  cmp al, 6
  je stop_music
  iret

  first:
  xor si, si
  mov byte ptr cur, 2
  mov word ptr melody, offset melody1
  mov word ptr beat, offset beat1
  iret

  second:
  xor si, si
  mov byte ptr cur, 3
  mov word ptr melody, offset melody2
  mov word ptr beat, offset beat2
  iret

  third:
  xor si, si
  mov byte ptr cur, 4
  mov word ptr melody, offset melody3
  mov word ptr beat, offset beat3
  iret

  fourth:
  xor si, si
  mov byte ptr cur, 5
  mov word ptr melody, offset melody4
  mov word ptr beat, offset beat4
  iret

  stop_music:
  xor si, si
  mov byte ptr cur, 6
  mov word ptr melody, 0
  mov word ptr beat, 0
  iret

  return:
  iret
handler endp

melody dw 0
beat dw 0
cur db 0

;               C(до)  C#   D(ре)  D#   E(ми) F(фа)  F#   G(со)  G#   A(ля)  A#   B(си)
frequency dw 0, 9121, 8609, 8126, 7670, 7239, 6833, 6449, 6087, 5746, 5423, 5119, 4831
          dw 4560, 4304, 4063, 3834, 3619, 3416, 3224, 3043, 2873, 2711, 2559, 2415
          dw 2280, 2152, 2031, 1917, 1809, 1715, 1612, 1521, 1436, 1355, 1292, 1207
          dw 1140, 1076, 1016, 959, 905, 854, 806, 760, 718, 678, 640, 604

; Chip and dale
beat1 db 4,4,1,4,1,4,1,4,6,4,1,4,1,4,1,4,1,4,1,4,1,4,3,4,1,4,1,4,1,4,1,4,1,4,1,4,1,4,1,9
      db 4,14,4,9,4,13,5,4,1,4,1,4,1,4,4,4,1,4,1,4,4,4,4,4,1,9,4,14,4,9,4,13,5,4,1,4,1,4
      db 2,4,4,4,1,4,1,4,1,4,1,4,4,4,1,4,1,1,4,1,4,1,4,4,4,1,4,1,4,3,4,4,4,3,4,1,4,1,4,2
      db 4,1,4,1,4,4,1,4,1,4,1,4,1,4,1,4,4,4,4,4,5,4,1,4,1,4,1,3,4,1,4,1,4,1,4,1,4,1,4,2
      db 4,4,4,1,4,1,4,1,4,1,4,6,3,4,1,4,1,4,1,4,1,4,1,4,1,4,4,4,3,4,1,4,1,4,1,4,1,4,4,2
      db 4,1,4,1,4,4,4,1,4,1,4,1,4,1,4,3,4,4,1,4,1,4,1,4,1,4,1,4,4,4,3,4,4,4,4,4,1,4,1,3
      db 4,1,4,1,4,1,4,1,4,1,4,1,4,4,4,1,4,1,4,1,4,1,4,6,3,4,1,4,1,4,1,4,1,4,1,4,1,4,4,4
      db 3,4,1,4,1,4,1,4,1,3,4,3,4,1,4,1,4,4,4,1,4,1,4,1,4,1,4,3,0FFH

melody1 db 0,40,0,40,0,40,0,40,0,39,0,39,0,39,0,39,0,39,0,39,0,39,0,39,0,39,0,39,0,39,0
        db 39,0,39,0,39,0,0,32,0,39,0,32,0,39,0,0,32,0,35,0,39,0,37,0,37,0,35,0,34,0,31
        db 0,0,32,0,39,0,32,0,39,0,0,32,0,35,0,39,0,39,0,39,0,37,0,37,0,35,0,37,0,0,40
        db 0,39,0,39,0,35,0,40,0,40,0,39,0,39,0,39,0,35,0,37,0,39,0,39,0,37,0,39,0,0,42
        db 0,42,0,42,0,42,0,42,0,41,0,41,0,41,0,41,0,37,0,39,0,0,39,0,41,0,42,0,42,0,42
        db 0,42,0,41,0,41,0,44,0,42,0,41,0,37,0,0,37,0,42,0,42,0,42,0,42,0,42,0,44,0,44
        db 0,42,0,40,0,39,0,40,0,0,40,0,37,0,39,0,40,0,44,0,42,0,42,0,40,0,42,0,0,45,0
        db 45,0,45,0,45,0,45,0,44,0,44,0,44,0,44,0,40,0,42,0,0,42,0,44,0,45,0,45,0,45,0
        db 45,0,44,0,44,0,47,0,45,0,44,0,40,0,0,40,0,45,0,45,0,45,0,45,0,45,0,47,0,47,0
        db 45,0,43,0,42,0,43,0,0,43,0,40,0,42,0,43,0,47,0,45,0,45,0,43,0,45,0,0ffh

; Megalovania
beat2 db 1000 dup (2)

melody2 db 0,15,0,15,27,22,21,20,18,0,15,18,20
        db 0,13,0,13,27,22,21,20,18,0,15,18,20
        db 0,12,0,12,27,22,21,20,18,0,15,18,20
        db 0,11,0,11,27,22,21,20,18,0,15,18,20
        db 0,27,0,27,0,39,34,33,32,30,0,30,27,30,32
        db 0,25,0,25,0,39,34,33,32,30,0,30,27,30,32
        db 0,24,0,24,0,39,34,33,32,30,0,30,27,30,32
        db 0,23,0,23,0,39,34,33,32,30,0,30,27,30,32
        db 0,30,0,30,30,0,30,0,30,27,27,0,30,0,30,30,0,32,33,33,32,27,30,32
        db 0,30,0,30,30,0,32,0,33,0,34,0,37,0,34,0,0,39,0,39,39,39,34,39,37
        db 0,34,0,34,34,0,34,0,34,32,32,0,34,0,34,34,0,34,32,34,39,34,32
        db 0,39,27,34,27,32,27,30,0,37,27,32,27,30,27,29,0,23,0,23,25,27,28,30,0,32,37
        db 0,30,27,30,32,33,32,30,27,0,33,32,30,27,30,0,0,0,0
        db 0,32,0,33,34,0,37,34,33,32,30,27,29,30,32,34,37,0,38,33,0,33,32,30,32,0,0,0
        db 0,30,32,34,42,41,39,0,41,0,42,0,44,0,41,0,46,0,0, 46,45,44,43,42,41,40,39,38,0,40
        db 11,11,11,11,11,11,0,18,18,0,17,17,17,17,0,15,15,15,15,0,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18,18
        db 11,11,11,11,11,11,0,18,18,0,17,17,17,17,0,15,15,15,15,0,15,15,15,15,15,15,15,15,15,15,15,15,15,14,13,12,11,10
        db 0,22,30,29,0,22,22,22,29,27,0,22,24,25
        db 0,11,11,0,23,0,11,11,0,11,0,11,0,13,13,0,25,0,13,13,0,13,0,15,15,0,15,0,14,14,0,14,0,13,13,0,13,0,12,12,0,12,0,23
        db 0,11,11,0,23,0,11,11,0,11,0,11,0,13,13,0,25,0,13,13,0,13,0,15,15,0,15,0,15,15,15,0,15,15,15,15,15
        db 0,11,11,0,27,0,22,0,21,20,0,18,18,15,18,20,0,13,13,0,27,22,0,21,20,0,18,18,15,18,20
        db 0,15,15,0,27,0,22,0,21,20,0,18,18,15,18,20,0,15,15,0,27,22,0,21,20,0,18,18,15,18,20
        db 0,11,11,0,27,0,22,0,21,20,0,18,18,15,18,20,0,13,13,0,27,22,0,21,20,0,18,18,15,18,20
        db 0ffh

; Blow with fires
beat3 db 6,2,3,2,2,2,3,2,4,2,10,2,4,2,3,2,4,2,5,2,9,2,4,2,3,2,3,2,7,2,3,2,5,2,3,2
      db 3,2,6,2,1,6,2,3,2,2,2,3,2,4,2,10,2,4,2,2,2,4,2,4,2,12,2,2,2,3,2,5,2,3,2
      db 3,2,3,2,4,2,11,2,2,2,4,2,4,2,3,2,4,2,2,2,5,2,1, 0ffh

melody3 db 0,25,0,29,0,22,0,25,0,20,0,25,0,29,0,22,0,27,0,32,0,27,0,29,0,30,0,30
        db 0,30,0,29,0,27,0,25,0,27,0,20,0,0,25,0,29,0,22,0,25,0,20,0,25,0,29,0
        db 22,0,27,0,32,0,34,0,30,0,27,0,29,0,32,0,27,0,29,0,25,0,34,0,30,0,27
        db 0,29,0,32,0,27,0,29,0,25,0,0ffh

; Eminem Lose Yourself
beat4 db 100 dup (4)

melody4 db 0,34,30,27,0,34,0,32,29,25,0,32,0,34,30,27,0,35,0,37,0,35,0,34,0,32
        db 0,34,0,30,0,27,0,34,0,32,29,25,0,32,0,34,30,27,0,0,39,35,32,0,39,0
        db 37,0,34,0,35,0,34,0,32,0,34,0,35,0,38,0, 0ffh

end start